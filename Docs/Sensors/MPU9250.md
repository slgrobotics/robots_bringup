**Back to** [Wiki](https://github.com/slgrobotics/articubot_one/wiki)

## MPU9250 Notes

See https://github.com/slgrobotics/robots_bringup/tree/main/Docs/Dragger for complete robot setup.

MPU9250 (GY-9250) is a 9-Axis 9 DOF Gyroscope, Acceleration and Magnetic Sensor Sensor Module. Supports either I2C or SPI connection.

### Positioning on the robot

Here is how I mount MPU9250 on my [Turtle](https://github.com/slgrobotics/robots_bringup/tree/main/Docs/Create1) robot (board upside down, VCC pin forward):

<img width="1311" height="1687" alt="Screenshot from 2026-01-24 19-55-28" src="https://github.com/user-attachments/assets/5a9d44ed-9a56-4e8d-89b9-832e21d35adb" />

On Plucky robot - same orientation (view facing front):
- https://photos.app.goo.gl/Qd4kcWqxq67jkmkR6
- https://photos.app.goo.gl/MViBSN8Vixknx6pm8

### Connections:

**Power:** There are small "_jumper pads_" next to GND pin. If open, 5V VCC is needed. If closed (soldered) - 3.3V is needed. 

For normal ROS2 operation, I2C connection is adequate, connect as follows:

Connect to Raspberry Pi  **I2C**: **SCL** - pin 05, **SDA** - pin 03

RPi GPIO header pinout: https://www.raspberrypi.com/documentation/computers/images/GPIO-Pinout-Diagram-2.png

_Optional:_ Consider 3 KOhm to 6.8 KOhm pull-up resistors from SDA and SCL to 3.3 V bus.

Use ```i2cdetect -y 1``` to see address **0x68** and **0x0C**

### Here is what I found while setting up IMU on Seggy, Dragger and Plucky robots.

The "standard" MPU9250 ROS2 driver (https://github.com/hiwad-aziz/ros2_mpu9250_driver) was not updating magnetometer/orientation values after startup. So, I looked for alternatives.

I switched to a Python-based ROS2 driver by **Nils Schulte** and had good success with it, including calibration.
I created my [GitHub fork](https://github.com/slgrobotics/mpu9250) of that driver, cleaned up the code and thoroughly tested it.

### The driver:

Original: https://github.com/Schnilz/mpu9250

My fork with significant changes: https://github.com/slgrobotics/mpu9250.git

### Installation and operation:

(on the robot's RPi5):
```
sudo apt install python3-smbus2 python3-easydict
cd ~/robot_ws/src
git clone https://github.com/slgrobotics/mpu9250.git
```
Node in launch file:
```
    mpu9250_driver_node = Node(
        package="mpu9250",
        namespace=namespace,
        executable="mpu9250",
        name="mpu9250",
        output='screen',
        respawn=True,
        respawn_delay=4,
        emulate_tty=True,
        parameters=[{
                "verbose": True,      # default False
                #"raw_only": True,    # default False ("fusing" mode). When True - only publish raw IMU data - /imu/data_raw and /imu/mag
                "frequency": 30,
                "temp_pub_rate_hz": 1.0,  # temperature publish rate in Hz
                "frame_id": "imu_link",
                "i2c_address": 0x68,  # also, 0x0C shows up for built-in AK8963 magnetometer
                "i2c_port": 1,        # a.k.a "bus". For Linux on Raspberry Pi Bus=1
                "acceleration_scale": [1.0, 1.0, 1.0],  # small adjustment of scale factors for each axis, should be around 1.0
                "acceleration_bias": [0.0, 0.0, 0.0],
                "gyro_bias": [0.0, 0.0, 0.0],
                # use tests/calibrate_mag.py to get mag calibration values
                "magnetometer_scale": [1.0, 1.0, 1.0],  # should be around 1.0
                "magnetometer_bias": [1.672994523195427e-05, 1.777942953037992e-05, 3.2817091139903744e-05],
                "magnetometer_transform": [
                    1.0160951390293467, 0.008597352199034276, -0.008498487872556243,
                    0.008597352199034368, 1.0040890425158557, 0.014842492476619326,
                    -0.008498487872556252, 0.014842492476619368, 0.980515572473782],
                "madgwick_beta": 0.1,       # beta is often in the 0.01–0.2 ballpark, weight of correction from accelerometer/magnetometer vs gyroscope
                "madgwick_use_mag": True
        }]
    )
```
My fork of the driver adds *"verbose"* parameter.
The *"magnetometer_bias"* and related parameters are derived by running [calibration script](https://github.com/slgrobotics/mpu9250/blob/main/tests/calibrate_mag.py).

You can launch the driver in *"raw_only"* and full Madgwick filter fusing mode. See related launch files [examples](https://github.com/slgrobotics/mpu9250/tree/main/launch).

### IMU visualization in RViz:

IMU tools:  https://github.com/CCNYRoboticsLab/imu_tools
```
sudo apt install ros-${ROS_DISTRO}-imu-tools
```
With [articubot_one](https://github.com/slgrobotics/articubot_one) repo cloned, use:
```
cd ~/robot_ws
colcon build; ros2 launch articubot_one launch_rviz.launch.py use_sim_time:=false
```
- and check "IMU" and "Mag" boxes on *Displays* panel.

### Calibration:

**Note:** Magnetometer calibration is **NOT OPTIONAL**. Do it:
- Run [calibration script](https://github.com/slgrobotics/mpu9250/blob/main/tests/calibrate_mag.py) - rotate the sensor in all possible orientations.
- copy/paste its output in your launch file.

Verify published */imu/mag* values for your [location](https://www.ngdc.noaa.gov/geomag/calculators/magcalc.shtml?#igrfwmm):

<img width="1417" height="247" alt="Screenshot from 2026-01-24 20-38-15" src="https://github.com/user-attachments/assets/c0ecc857-4c37-4264-a70e-839081e911f8" />

Note: magnetic field is published in Tesla, the NOAA site gives values in microTesla.

Turn the robot around - the published values should roughly coform to this matrix:
```
         |   x   |   y   |   z   |
----------------------------------
  North  |  20   |   0   |  -40  |
  East   |   0   |  20   |  -40  |
  South  | -20   |   0   |  -40  |
  West   |   0   |  -20  |  -40  |
----------------------------------
```
Tip: 2.0000e-05 Tesla = 20 micro Tesla

---------------------

### Useful links:

- https://www.youtube.com/watch?v=-Uq7AmSAjt8
- https://www.youtube.com/watch?v=cGI8mrIanpk

    "A written version of this guide can be found here":
         https://www.digikey.com/en/maker/projects/how-to-calibrate-a-magnetometer/50f6bc8f36454a03b664dca30cf33a8b
    
- Adafruit SensorLab: https://github.com/adafruit/Adafruit_SensorLab
- PJRC MotionCal: https://www.pjrc.com/store/prop_shield.html    https://github.com/PaulStoffregen/MotionCal
- NOAA magnetic declination calculator: https://www.ngdc.noaa.gov/geomag/declination.shtml
- https://github.com/niru-5/imusensor
- https://github.com/niru-5/imusensor/tree/master/examples/mag_caliberation

## Just in case - setting up the "Standard" ros2_mpu9250_driver

**Note:** it was not updating magnetometer/orientation values after startup. Not good.

```
git clone https://github.com/hiwad-aziz/ros2_mpu9250_driver.git

vi ~/robot_ws/src/ros2_mpu9250_driver/src/mpu9250driver.cpp
   - line 48:   message.header.frame_id = "imu_link"; (was "base_link")

[Ubuntu 24.04 only]:
vi ~/robot_ws/src/ros2_mpu9250_driver/lib/mpu9250sensor/include/mpu9250sensor/mpu9250sensor.h
   - line 6 insert "#include <array>"
```
 And the node in the launch file:
```
    mpu9250driver_node = Node(
        package='mpu9250driver',
        executable='mpu9250driver',
        name='mpu9250driver_node',
        output='screen',
        respawn=True,
        respawn_delay=4,
        emulate_tty=True,
        parameters=[
          {'calibrate': True },
          {'gyro_range': 0 },     # Gyroscope range: 0 -> +-250°/s, 1 -> +-500°/s, 2 -> +-1000°/s, 3 -> +-2000°/s
          {'accel_range': 0 },    # Acceleration range: 0 -> +-2g, 1 -> +-4g, 2 -> +-8g, 3 -> +-16g
          {'dlpf_bandwidth': 2 },   # Digital low pass filter bandwidth [0-6]: 0 -> 260Hz, 1 -> 184Hz, 2 -> 94Hz, 3 -> 44Hz, 4 -> 21Hz, 5 -> 10Hz, 6 -> 5Hz
          {'gyro_x_offset':  0.0 },  # If "calibrate" is true, these values will be overriden by the calibration procedure
          {'gyro_y_offset': 0.0},
          {'gyro_z_offset': 0.0 },
          {'accel_x_offset': 0.0 },
          {'accel_y_offset': 0.0 },
          {'accel_z_offset': 0.0 },
          {'frequency': 100 }
        ]
    )
```

----------------

**Back to** [Wiki](https://github.com/slgrobotics/articubot_one/wiki) or [Docs Folder](https://github.com/slgrobotics/robots_bringup/tree/main/Docs)
